<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>ELIMINATOR</title>
  <style>
    /* ============================================================
      ELIMINATOR v1.27 — single-file — 2 parties
      PARTIE 1/2 : HTML + CSS
      - 2 modes: pastel clair / pastel foncé
      - saisons: printemps / été / automne / hiver (nature, no mauve)
      - topbar sticky vitré
      - centre scrollable (pas hub absolute)
      - barre de progression massive + pomodoro intégré sous la barre
      - panneaux latéraux redimensionnables
      - focus overlay
    ============================================================ */

    :root{
      --font: ui-rounded, "SF Pro Rounded", "Segoe UI Rounded", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;

      --appW: min(1200px, 96vw);
      --radius: 10px;
      --radius2: 8px;
      --lineW: 1px;

      --blur: 16px;
      --shadowA: 0 18px 70px rgba(0,0,0,.14);
      --shadowB: 0 10px 30px rgba(0,0,0,.10);

      --drawerW: 420px;
      --rightW: 520px;

      /* Progress size (BIG) */
      --progressH: clamp(170px, 26vh, 320px);

      /* Defaults overwritten by theme/palette */
      --bg: #f6fbff;
      --fg: #11151d;
      --muted: rgba(17,21,29,.72);
      --glass: rgba(255,255,255,.62);
      --glass2: rgba(255,255,255,.36);
      --line: rgba(17,21,29,.16);

      --accent: rgba(205,120,60,.28);
      --accent2: rgba(205,120,60,.68);

      --barA: rgba(205,120,60,.30);
      --barB: rgba(205,120,60,.92);

      --haloA: rgba(205,120,60,.18);
      --haloB: rgba(120,160,200,.14);

      --grain: .10;
      --uiDensity: 1;
    }

    body[data-theme="pastel-dark"]{
      --bg: #0f1420;
      --fg: #f2f6ff;
      --muted: rgba(242,246,255,.74);
      --glass: rgba(20,28,44,.64);
      --glass2: rgba(20,28,44,.36);
      --line: rgba(242,246,255,.18);
      --shadowA: 0 22px 90px rgba(0,0,0,.46);
      --shadowB: 0 12px 40px rgba(0,0,0,.36);
      --grain: .12;
    }

    /* Saison palettes (no mauve) */
    body[data-season="printemps"]{
      --accent: rgba(110,190,150,.26);
      --accent2: rgba(110,190,150,.72);
      --barA: rgba(110,190,150,.28);
      --barB: rgba(110,190,150,.92);
      --haloA: rgba(110,190,150,.18);
      --haloB: rgba(255,185,90,.14);
    }
    body[data-season="ete"]{
      --accent: rgba(90,170,210,.24);
      --accent2: rgba(90,170,210,.66);
      --barA: rgba(255,185,90,.30);
      --barB: rgba(255,185,90,.92);
      --haloA: rgba(90,170,210,.14);
      --haloB: rgba(255,185,90,.14);
    }
    body[data-season="automne"]{
      --accent: rgba(205,120,60,.28);
      --accent2: rgba(205,120,60,.72);
      --barA: rgba(205,120,60,.32);
      --barB: rgba(205,120,60,.94);
      --haloA: rgba(205,120,60,.18);
      --haloB: rgba(150,70,60,.12);
    }
    body[data-season="hiver"]{
      --accent: rgba(120,160,200,.22);
      --accent2: rgba(120,160,200,.58);
      --barA: rgba(150,70,60,.28);   /* bordeaux glacé */
      --barB: rgba(150,70,60,.92);
      --haloA: rgba(120,160,200,.14);
      --haloB: rgba(150,70,60,.14);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--fg);
      background: var(--bg);
      overflow-x:hidden;
    }

    /* Background Ghibli-ish: sky + clouds + grain */
    .bgSky{
      position:fixed; inset:0; z-index:-10;
      background:
        radial-gradient(1200px 720px at 18% 14%, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(980px 620px at 78% 20%, rgba(0,0,0,.06), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.18), transparent 45%),
        var(--bg);
      overflow:hidden;
    }
    body[data-theme="pastel-dark"] .bgSky{
      background:
        radial-gradient(1200px 720px at 18% 14%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(980px 620px at 78% 20%, rgba(0,0,0,.30), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.06), transparent 45%),
        var(--bg);
    }
    .bgSky::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      opacity: var(--grain);
      background-image:
        repeating-linear-gradient(0deg, rgba(0,0,0,.10) 0, rgba(0,0,0,.10) 1px, transparent 1px, transparent 3px),
        repeating-linear-gradient(90deg, rgba(0,0,0,.06) 0, rgba(0,0,0,.06) 1px, transparent 1px, transparent 4px);
      mix-blend-mode: soft-light;
      filter: blur(.2px);
    }
    body[data-theme="pastel-dark"] .bgSky::after{
      background-image:
        repeating-linear-gradient(0deg, rgba(255,255,255,.10) 0, rgba(255,255,255,.10) 1px, transparent 1px, transparent 3px),
        repeating-linear-gradient(90deg, rgba(255,255,255,.06) 0, rgba(255,255,255,.06) 1px, transparent 1px, transparent 4px);
      mix-blend-mode: overlay;
    }

    .cloudLayer{
      position:absolute; inset:-20vh -20vw;
      opacity:.55;
      pointer-events:none;
      filter: blur(.3px);
      transform: translate3d(0,0,0);
    }
    .clouds1{
      background:
        radial-gradient(280px 140px at 12% 18%, rgba(255,255,255,.70), transparent 60%),
        radial-gradient(340px 170px at 24% 24%, rgba(255,255,255,.54), transparent 62%),
        radial-gradient(430px 210px at 70% 20%, rgba(255,255,255,.55), transparent 64%),
        radial-gradient(260px 140px at 82% 28%, rgba(255,255,255,.62), transparent 62%);
      animation: drift1 42s linear infinite;
    }
    .clouds2{
      opacity:.38;
      background:
        radial-gradient(320px 160px at 18% 62%, rgba(255,255,255,.45), transparent 62%),
        radial-gradient(440px 220px at 38% 66%, rgba(255,255,255,.32), transparent 64%),
        radial-gradient(540px 260px at 82% 62%, rgba(255,255,255,.32), transparent 64%);
      animation: drift2 68s linear infinite;
    }
    body[data-theme="pastel-dark"] .cloudLayer{ opacity:.18; }
    @keyframes drift1{ 0%{transform:translateX(-6%) translateY(0%)} 100%{transform:translateX(6%) translateY(-2%)} }
    @keyframes drift2{ 0%{transform:translateX(6%) translateY(2%)} 100%{transform:translateX(-6%) translateY(0%)} }

    /* Pollen canvas */
    #pollenCanvas, #confettiCanvas{
      position:fixed; inset:0; z-index:-5;
      width:100vw; height:100vh;
      pointer-events:none;
    }
    #confettiCanvas{ z-index:200; }

    /* Layout: topbar sticky + main centered scrollable */
    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding: 12px 12px 24px;
      gap: 12px;
    }

    .topbar{
      width: var(--appW);
      position: sticky;
      top: 10px;
      z-index: 60;

      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;

      padding: calc(10px * var(--uiDensity)) calc(12px * var(--uiDensity));
      border: var(--lineW) solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadowA);
    }

    .tb-left,.tb-right{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      min-width:0;
    }

    .btn{
      border: var(--lineW) solid var(--line);
      background: transparent;
      color: var(--fg);
      border-radius: var(--radius2);
      padding: calc(8px * var(--uiDensity)) calc(10px * var(--uiDensity));
      font-size: 13px;
      cursor:pointer;
      user-select:none;
      transition: transform 140ms ease, background 140ms ease;
      white-space:nowrap;
    }
    .btn:hover{ background: rgba(0,0,0,.04); }
    body[data-theme="pastel-dark"] .btn:hover{ background: rgba(255,255,255,.06); }
    .btn:active{ transform: translateY(1px); }

    .iconbtn{
      width:40px; height:36px;
      display:grid; place-items:center;
      padding:0;
      font-family: var(--mono);
      font-size: 15px;
    }

    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      border: var(--lineW) solid var(--line);
      background: rgba(0,0,0,.03);
      color: var(--muted);
      font-size: 12px;
      font-family: var(--mono);
    }
    body[data-theme="pastel-dark"] .pill{ background: rgba(255,255,255,.05); }

    .main{
      width: var(--appW);
      flex:1;
      display:flex;
      flex-direction:column;
      gap: 12px;
      padding-bottom: 18px;
    }

    .card{
      border: var(--lineW) solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadowA);
      overflow:hidden;
      position:relative;
    }

    .halo{
      position:absolute; inset:-60% -30%;
      pointer-events:none;
      opacity:.52;
      background:
        radial-gradient(circle at 18% 34%, var(--haloA), transparent 54%),
        radial-gradient(circle at 70% 28%, var(--haloB), transparent 56%),
        radial-gradient(circle at 50% 70%, rgba(255,255,255,.10), transparent 56%);
      filter: blur(2px);
      transform: rotate(8deg);
      animation: halo 2.8s ease-in-out infinite alternate;
    }
    @keyframes halo{
      0%{ transform: rotate(6deg) scale(1.02); opacity:.42; }
      100%{ transform: rotate(10deg) scale(1.10); opacity:.62; }
    }

    /* Title lower (closer to bar) */
    .hero{
      padding: 18px 14px 6px;
      text-align:center;
    }
    .title{
      font-weight: 950;
      letter-spacing:.08em;
      font-size: clamp(42px, 4.7vw, 72px);
      margin: 10px 0 6px;
      text-shadow: 0 18px 50px rgba(0,0,0,.12);
    }
    .tagline{
      font-family: var(--mono);
      font-size: 13px;
      color: var(--muted);
      margin: 0 0 4px;
    }

    /* Progress BIG + contrast */
    .progressWrap{
      padding: 10px 14px 14px;
    }
    .bar{
      height: var(--progressH);
      border-radius: calc(var(--radius) - 2px);
      border: var(--lineW) solid rgba(0,0,0,.24);
      background: rgba(0,0,0,.04);
      position:relative;
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.16);
    }
    body[data-theme="pastel-dark"] .bar{
      border-color: rgba(255,255,255,.24);
      background: rgba(255,255,255,.06);
    }
    .bar::after{
      content:"";
      position:absolute; inset:-30%;
      background: radial-gradient(circle at 20% 30%, rgba(255,255,255,.18), transparent 50%);
      opacity:.85;
      pointer-events:none;
    }
    .barFill{
      position:absolute; inset:0;
      width:100%;
      background:
        radial-gradient(900px 240px at 22% 50%, var(--barB), transparent 62%),
        linear-gradient(90deg, var(--barA), transparent 82%);
      transition: width 260ms ease;
      filter: saturate(1.08);
    }
    .barPct{
      position:absolute; inset:0;
      display:grid; place-items:center;
      font-family: var(--mono);
      font-size: clamp(14px, 2.2vw, 22px);
      text-shadow: 0 10px 30px rgba(0,0,0,.18);
      opacity:.94;
      pointer-events:none;
    }

    /* Pomodoro row inside progress area */
    .pomoRow{
      margin-top: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .pomoClock{
      display:flex; align-items:baseline; gap:10px;
      user-select:none;
      cursor:pointer;
    }
    .pomoTime{ font-family: var(--mono); font-size: 22px; letter-spacing:.04em; }
    .pomoHint{ font-family: var(--mono); font-size: 12px; color: var(--muted); }

    .underBar{
      margin-top: 10px;
      text-align:center;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
    }

    /* Task block */
    .taskWrap{ padding: 12px 14px 16px; }
    .taskName{
      font-weight: 950;
      font-size: clamp(26px, 3.2vw, 54px);
      text-align:center;
      margin: 8px 0 10px;
      line-height:1.06;
      word-break: break-word;
    }
    .chips{
      display:flex; flex-wrap:wrap;
      justify-content:center;
      gap:6px;
      margin-bottom: 12px;
    }
    .chip{
      width: 18px; height: 18px;
      border-radius: 6px;
      border: var(--lineW) solid var(--line);
      background: rgba(0,0,0,.03);
      transition: transform 140ms ease, background 140ms ease;
    }
    body[data-theme="pastel-dark"] .chip{ background: rgba(255,255,255,.05); }
    .chip.on{ background: var(--accent2); }

    .actions{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 12px;
      flex-wrap:wrap;
      margin: 8px 0 10px;
    }
    .mini{
      border: var(--lineW) solid var(--line);
      border-radius: var(--radius2);
      background: transparent;
      box-shadow: var(--shadowB);
      padding: 10px 10px;
      cursor:pointer;
      user-select:none;
      display:flex;
      gap:8px;
      align-items:center;
      transition: transform 140ms ease, background 140ms ease;
      font-size: 13px;
    }
    .mini:hover{ background: rgba(0,0,0,.03); }
    body[data-theme="pastel-dark"] .mini:hover{ background: rgba(255,255,255,.06); }
    .mini:active{ transform: translateY(1px) scale(.99); }
    .mini .ic{ font-family: var(--mono); font-size: 14px; }
    .mini small{ color: var(--muted); font-family: var(--mono); font-size: 12px; }

    .roulette{
      width: clamp(120px, 16vw, 190px);
      height: clamp(120px, 16vw, 190px);
      border-radius: 999px;
      border: var(--lineW) solid var(--line);
      background:
        radial-gradient(circle at 30% 30%, var(--glass2), transparent 60%),
        radial-gradient(circle at 70% 60%, var(--accent2), transparent 65%),
        linear-gradient(180deg, var(--glass2), transparent);
      box-shadow: var(--shadowA);
      backdrop-filter: blur(var(--blur));
      display:grid;
      place-items:center;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      transition: transform 140ms ease;
    }
    .roulette:active{ transform: translateY(1px) scale(.99); }
    .roulette::after{
      content:"";
      position:absolute; inset:10px;
      border-radius:999px;
      border: 1px dashed rgba(0,0,0,.18);
      opacity:.8;
    }
    body[data-theme="pastel-dark"] .roulette::after{ border-color: rgba(255,255,255,.22); }
    .rouletteText{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing:.10em;
      opacity:.92;
    }
    .spin{ animation: spin 860ms cubic-bezier(.08,.92,.20,1) 1; }
    @keyframes spin{ 0%{ transform: rotate(0deg);} 100%{ transform: rotate(1080deg);} }

    .bigAction{
      min-width: clamp(220px, 30vw, 360px);
      padding: 14px 16px;
      border-radius: var(--radius2);
      border: var(--lineW) solid var(--line);
      background: linear-gradient(180deg, var(--glass2), transparent);
      box-shadow: var(--shadowA);
      cursor:pointer;
      user-select:none;
      display:flex; align-items:center; justify-content:center; gap:12px;
      transition: transform 140ms ease, background 140ms ease;
    }
    .bigAction:hover{ background: rgba(0,0,0,.03); }
    body[data-theme="pastel-dark"] .bigAction:hover{ background: rgba(255,255,255,.06); }
    .bigAction:active{ transform: translateY(1px) scale(.99); }
    .bigAction .em{ font-family: var(--mono); font-size: 18px; }
    .bigAction .label{ display:flex; flex-direction:column; line-height:1.12; align-items:center; }
    .bigAction .label b{ font-size: 14px; font-weight: 950; }
    .bigAction .label span{ font-size: 12px; color: var(--muted); font-family: var(--mono); }

    /* Inline list under tasks */
    .belowList{
      margin-top: 10px;
      display:none;
      padding: 10px;
      border-top: var(--lineW) solid var(--line);
    }
    .belowList.show{ display:block; }
    .listRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 8px 6px;
      border-bottom: var(--lineW) solid var(--line);
    }
    .listRow:last-child{ border-bottom:none; }
    .listRow .t{
      flex:1; min-width:0;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      font-size: 13px;
    }
    .listRow .m{
      font-family: var(--mono);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .tools{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .tool{
      border: var(--lineW) solid var(--line);
      border-radius: var(--radius2);
      padding: 6px 8px;
      cursor:pointer;
      user-select:none;
      font-size: 12px;
      font-family: var(--mono);
      color: var(--fg);
      background: transparent;
      transition: background 140ms ease, transform 140ms ease;
    }
    .tool:hover{ background: rgba(0,0,0,.03); }
    body[data-theme="pastel-dark"] .tool:hover{ background: rgba(255,255,255,.06); }
    .tool:active{ transform: translateY(1px); }

    /* Side panels */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      display:none;
      z-index:80;
    }
    .panel{
      position:fixed; top:0; bottom:0;
      background: var(--glass);
      border: var(--lineW) solid var(--line);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadowA);
      z-index:90;
      display:flex;
      flex-direction:column;
      width: min(var(--drawerW), 94vw);
      transform: translateX(-110%);
      transition: transform 220ms ease;
    }
    .panel.right{
      right:0; left:auto;
      width: min(var(--rightW), 94vw);
      transform: translateX(110%);
    }
    .panel.open{ transform: translateX(0); }
    .backdrop.show{ display:block; }

    .panelTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 12px;
      border-bottom: var(--lineW) solid var(--line);
    }
    .panelTop .ttl{
      font-family: var(--mono);
      color: var(--muted);
      font-size: 12px;
      letter-spacing:.04em;
    }
    .panelBody{
      padding: 12px;
      overflow:auto;
    }
    .resizer{
      position:absolute; top:0; bottom:0;
      width:12px;
      cursor: ew-resize;
      opacity:0;
    }
    .panel.left .resizer{ right:-6px; }
    .panel.right .resizer{ left:-6px; }
    .panel:hover .resizer{ opacity:1; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; padding: 10px 12px 0; }
    .tab{
      padding: 7px 9px;
      border-radius: var(--radius2);
      border: var(--lineW) solid var(--line);
      cursor:pointer;
      font-size: 13px;
      color: var(--muted);
      background: transparent;
      transition: background 140ms ease;
      user-select:none;
    }
    .tab:hover{ background: rgba(0,0,0,.03); }
    body[data-theme="pastel-dark"] .tab:hover{ background: rgba(255,255,255,.06); }
    .tab.active{
      color: var(--fg);
      background: linear-gradient(180deg, var(--glass2), transparent);
      box-shadow: inset 0 0 0 1px var(--line);
    }

    .section{
      border: var(--lineW) solid var(--line);
      border-radius: var(--radius);
      padding: 10px;
      background: rgba(0,0,0,.02);
    }
    body[data-theme="pastel-dark"] .section{ background: rgba(255,255,255,.04); }
    .section h3{
      margin:0 0 8px;
      font-size: 12px;
      color: var(--muted);
      font-family: var(--mono);
      letter-spacing:.02em;
      font-weight: 900;
    }

    textarea,input,select{
      width:100%;
      border: var(--lineW) solid var(--line);
      border-radius: var(--radius2);
      padding: 10px;
      background: transparent;
      color: var(--fg);
      font-size: 13px;
      outline:none;
      font-family: var(--font);
    }
    textarea{ min-height: 160px; resize:vertical; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex:1; min-width: 160px; }
    .muted{ color: var(--muted); font-family: var(--mono); font-size: 12px; }

    /* Modals */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(12px);
      display:none;
      z-index:120;
    }
    .modal{
      position:fixed; inset:0;
      display:none;
      z-index:130;
      padding: 18px;
      align-items:center;
      justify-content:center;
    }
    .modal.show, .modalBack.show{ display:flex; }
    .modalCard{
      width: min(1040px, 96vw);
      max-height: 90vh;
      overflow:auto;
      border: var(--lineW) solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadowA);
      padding: 12px;
      position:relative;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 6px 6px 10px;
      border-bottom: var(--lineW) solid var(--line);
      margin-bottom: 10px;
    }
    .modalHead .mh{
      font-family: var(--mono);
      color: var(--muted);
      font-size: 12px;
    }

    /* Focus overlay */
    .focusOverlay{
      position:fixed; inset:0;
      display:none;
      z-index:150;
      background:
        radial-gradient(1200px 700px at 20% 20%, rgba(255,255,255,.18), transparent 62%),
        rgba(0,0,0,.36);
      backdrop-filter: blur(8px);
      padding: 16px;
      overflow:auto;
    }
    body[data-theme="pastel-dark"] .focusOverlay{
      background:
        radial-gradient(1200px 700px at 20% 20%, rgba(255,255,255,.06), transparent 62%),
        rgba(0,0,0,.62);
    }
    .focusOverlay.show{ display:block; }

    .focusCard{
      width: min(980px, 96vw);
      margin: 4vh auto;
      border: var(--lineW) solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadowA);
      overflow:hidden;
      position:relative;
    }
    .focusTop{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding: 10px 12px;
      border-bottom: var(--lineW) solid var(--line);
    }
    .focusBody{ padding: 14px; }
    .focusBigTask{
      font-weight: 950;
      font-size: clamp(30px, 4.2vw, 68px);
      line-height: 1.04;
      text-align:center;
      margin: 12px 0 8px;
    }

    @media (max-width: 560px){
      .btn{ font-size: 12px; }
      .tool{ font-size: 11px; padding: 6px 7px; }
    }
  </style>
</head>

<body data-theme="pastel-light" data-season="automne">
  <div class="bgSky" aria-hidden="true">
    <div class="cloudLayer clouds1"></div>
    <div class="cloudLayer clouds2"></div>
  </div>

  <canvas id="pollenCanvas"></canvas>
  <canvas id="confettiCanvas"></canvas>

  <!-- LEFT PANEL -->
  <div class="backdrop" id="leftBack"></div>
  <div class="panel left" id="leftPanel" aria-hidden="true">
    <div class="resizer" id="leftResizer" title="Redimensionner"></div>
    <div class="panelTop">
      <div class="ttl">menu</div>
      <button class="btn" id="leftClose">fermer</button>
    </div>
    <div class="tabs" id="leftTabs"></div>
    <div class="panelBody" id="leftBody"></div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="backdrop" id="rightBack"></div>
  <div class="panel right" id="rightPanel" aria-hidden="true">
    <div class="resizer" id="rightResizer" title="Redimensionner"></div>
    <div class="panelTop">
      <div class="ttl">panneau</div>
      <button class="btn" id="rightClose">fermer</button>
    </div>
    <div class="tabs" id="rightTabs"></div>
    <div class="panelBody" id="rightBody"></div>
  </div>

  <!-- MODAL BACKDROP -->
  <div class="modalBack" id="modalBack"></div>

  <!-- NOTES MODAL -->
  <div class="modal" id="notesModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalHead">
        <div class="mh">notes</div>
        <div class="muted">clique dehors pour fermer</div>
      </div>
      <div class="section">
        <h3>ajouter</h3>
        <textarea id="noteInput" placeholder="Une note. Pas une saga."></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="noteAdd">ajouter</button>
          <button class="btn" id="noteClear">vider</button>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="section">
        <h3>historique</h3>
        <div id="notesList" class="muted"></div>
      </div>
    </div>
  </div>

  <!-- KIFFANCE MODAL -->
  <div class="modal" id="kiffModal" aria-hidden="true">
    <div class="modalCard" style="min-height:min(58vh,720px); display:flex; flex-direction:column; justify-content:center; overflow:hidden;">
      <div class="halo" aria-hidden="true"></div>
      <div id="kiffTitle" style="font-size:clamp(20px,3.8vw,52px); font-weight:950; text-align:center; letter-spacing:.04em; margin:0 0 10px;"></div>
      <div id="kiffMsg" style="font-size:clamp(14px,1.8vw,22px); text-align:center; line-height:1.55; max-width:78ch; margin:0 auto 12px;"></div>
      <div id="kiffSub" class="muted" style="text-align:center"></div>
      <div class="muted" style="margin-top:14px; text-align:center;">clique dehors pour fermer</div>
    </div>
  </div>

  <!-- VICTORY MODAL -->
  <div class="modal" id="victoryModal" aria-hidden="true">
    <div class="modalCard" style="min-height:min(72vh,780px); display:flex; flex-direction:column; justify-content:center; overflow:hidden;">
      <div class="halo" aria-hidden="true"></div>
      <div id="victoryTitle" style="font-size:clamp(22px,4.2vw,58px); font-weight:950; text-align:center; letter-spacing:.04em; margin:0 0 10px;"></div>
      <div id="victoryMsg" style="font-size:clamp(14px,1.8vw,22px); text-align:center; line-height:1.55; max-width:78ch; margin:0 auto 12px;"></div>
      <div class="muted" style="text-align:center;">clique dehors pour fermer</div>
    </div>
  </div>

  <!-- TASK EDIT MODAL -->
  <div class="modal" id="taskEditModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalHead">
        <div class="mh">éditer tâche</div>
        <div class="muted">clique dehors pour fermer</div>
      </div>
      <div id="taskEditBody"></div>
    </div>
  </div>

  <!-- CALENDAR DAY MODAL -->
  <div class="modal" id="calModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalHead">
        <div class="mh" id="calModalTitle">jour</div>
        <div class="muted">clique dehors pour fermer</div>
      </div>
      <div id="calModalBody"></div>
    </div>
  </div>

  <!-- EXPORT MODAL -->
  <div class="modal" id="exportModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalHead">
        <div class="mh">export (texte)</div>
        <div class="muted">clique dehors pour fermer</div>
      </div>
      <div class="section">
        <h3>rapport</h3>
        <div class="row" style="margin-bottom:8px">
          <button class="btn" id="expRefresh">rafraîchir</button>
          <button class="btn" id="expCopy">copier</button>
        </div>
        <textarea id="expOut" style="min-height:320px"></textarea>
      </div>
    </div>
  </div>

  <!-- FOCUS OVERLAY -->
  <div class="focusOverlay" id="focusOverlay" aria-hidden="true">
    <div class="focusCard">
      <div class="halo" aria-hidden="true"></div>
      <div class="focusTop">
        <div class="muted"><b>ELIMINATOR</b> · focus</div>
        <button class="btn" id="btnExitFocus">quitter</button>
      </div>
      <div class="focusBody">
        <div class="bar">
          <div class="barFill" id="fBarFill" style="width:100%"></div>
          <div class="barPct" id="fBarPct">100%</div>
        </div>

        <div class="pomoRow">
          <div class="pomoClock" id="fPomoClick" title="cliquer pour régler">
            <div class="pomoTime" id="fPomoTime">25:00</div>
            <div class="pomoHint" id="fPomoHint">pomodoro</div>
          </div>
          <div class="tools">
            <button class="tool" id="fPomoAction">start</button>
            <button class="tool" id="fPomoStop" disabled>stop</button>
          </div>
        </div>

        <div class="focusBigTask" id="fTaskName">aucune tâche</div>
        <div class="chips" id="fChips"></div>

        <div class="actions">
          <div class="mini" id="fUndo"><span class="ic">↶</span><small>undo</small></div>
          <div class="mini" id="fNotes"><span class="ic">✎</span><small>notes</small></div>
          <div class="mini" id="fPause"><span class="ic">⏸</span><small>pause</small></div>
          <div class="mini" id="fKiff"><span class="ic">✶</span><small>kiff</small></div>
          <div class="bigAction" id="fEto"><div class="em">/</div><div class="label"><b>dégommer</b><span>1 étorion</span></div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap" id="app">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="tb-left">
        <button class="btn iconbtn" id="btnLeft" title="menu">≡</button>

        <button class="btn" id="btnTheme" title="mode">
          ☼ <span id="themeLbl">pastel clair</span>
        </button>

        <button class="btn" id="btnSeason" title="saison">
          ✿ <span id="seasonLbl">automne</span>
        </button>

        <button class="btn" id="btnFocus" title="focus">
          ◎ <span>focus</span>
        </button>

        <span class="pill" id="hudPill">0/0 · 00:00</span>
      </div>

      <div class="tb-right">
        <button class="btn iconbtn" id="btnRight" title="panneau">▦</button>
      </div>
    </div>

    <!-- MAIN CENTER (scrollable normal) -->
    <div class="main">
      <div class="card" id="mainCard">
        <div class="halo" aria-hidden="true"></div>

        <div class="hero">
          <div class="title" id="appTitle">ELIMINATOR</div>
          <div class="tagline" id="tagline">Ton empire réclame un coup de balai cosmique.</div>
        </div>

        <div class="progressWrap">
          <div class="bar" title="La barre part de 100% et diminue">
            <div class="barFill" id="barFill" style="width:100%"></div>
            <div class="barPct" id="barPct">100%</div>
          </div>

          <div class="pomoRow" id="pomoRow">
            <div class="pomoClock" id="pomoClick" title="cliquer pour régler">
              <div class="pomoTime" id="pomoTime">25:00</div>
              <div class="pomoHint" id="pomoHint">pomodoro prêt</div>
            </div>
            <div class="tools">
              <button class="tool" id="pomoToggle">masquer</button>
              <button class="tool" id="pomoAction">start</button>
              <button class="tool" id="pomoStop" disabled>stop</button>
            </div>
          </div>

          <div class="underBar" id="underBarLine">Ici, on avance. Même si le destin fait la grimace.</div>
        </div>

        <div class="taskWrap">
          <div class="taskName" id="taskName">aucune tâche</div>
          <div class="chips" id="etorChips"></div>

          <div class="actions">
            <div class="mini" id="btnUndo"><span class="ic">↶</span><small>undo</small></div>

            <div class="roulette" id="btnRoulette" title="roulette">
              <div class="rouletteText">roulette</div>
            </div>

            <div class="bigAction" id="btnEto" title="dégommer 1 étorion">
              <div class="em">/</div>
              <div class="label">
                <b>dégommer</b>
                <span>1 étorion</span>
              </div>
            </div>
          </div>

          <div class="actions" style="margin-top:0">
            <div class="mini" id="btnNotes"><span class="ic">✎</span><small>notes</small></div>
            <div class="mini" id="btnList"><span class="ic">≣</span><small>liste</small></div>
            <div class="mini" id="btnEdit"><span class="ic">⌁</span><small>édit</small></div>
            <div class="mini" id="btnPause"><span class="ic">⏸</span><small>pause</small></div>
            <div class="mini" id="btnKiff"><span class="ic">✶</span><small>kiff</small></div>
          </div>

          <div class="belowList" id="belowList">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:6px;">
              <div class="muted">liste en cours</div>
              <button class="btn" id="btnHideList">masquer</button>
            </div>
            <div id="belowRows"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PARTIE 2/2 JS juste après -->

  <!-- =========================
PARTIE 2/2 — JS complet (state, thèmes saisons, tâches, progression, pomodoro, focus, kiffance, panels, sets/habits/mood/calendar/stats/export)
À coller APRÈS la PARTIE 1/2, dans le même fichier .html
========================= -->

<script>
/* ============================================================
  ELIMINATOR v1.26.2 — Part 2/2
  Objectif: robuste, zéro dépendances, IDs cohérents, 2 modes visuels + saisons
============================================================ */

/* ---------- Utils ---------- */
const $ = (id) => document.getElementById(id);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const clamp = (n,a,b)=>Math.max(a, Math.min(b,n));
const uid = ()=>Math.random().toString(36).slice(2,10)+"_"+Date.now().toString(36);
const nowISO = ()=>new Date().toISOString();
const escapeHTML = (s)=>String(s??"").replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
const isReduced = ()=>window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

function dayKey(d=new Date()){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function formatMMSS(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const mm = String(Math.floor(s/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  return `${mm}:${ss}`;
}

/* ---------- Storage ---------- */
const LS_KEY = "eliminator_v1_26_2";
function deepAssign(t,s){
  for(const k in s){
    if(s[k] && typeof s[k]==="object" && !Array.isArray(s[k]) && t[k]){
      deepAssign(t[k], s[k]);
    } else t[k]=s[k];
  }
}
const defaultState = {
  ui:{
    theme:"pastel-light",     // "pastel-light" | "pastel-dark" (2 modes seulement)
    season:"automne",         // "printemps" | "ete" | "automne" | "hiver"
    showTagline:true,
    showPomodoro:true,
    showBelowList:false,
    reduceMotion:false,
    // progress size (CSS variable written by JS)
    progressH: null,          // null => CSS default
    // panels width
    leftW: 420,
    rightW: 560
  },
  timer:{ startedAt:null, pausedAt:null, pausedTotal:0 },
  pomodoro:{ minutes:25, running:false, paused:false, endsAt:null, pausedLeftMs:null, visible:true },
  tasks:[],
  baseline:{ totalTasks:0, totalEtorions:0 },
  currentTaskId:null,
  undo:[],
  stats:{ tasksDone:0, etorionsDone:0 },
  notes:[],
  // right panel features
  sets:{ list:[], selectedId:null },
  habits:[],
  mood:{ entries:[] },
  planner:{ items:[] },
  kiffance:{
    enabledBuckets:["5","10","15","25"],
    bank:{ "5":[], "10":[], "15":[], "25":[] },
    lastPickAt:null
  }
};

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return structuredClone(defaultState);
    const parsed = JSON.parse(raw);
    const merged = structuredClone(defaultState);
    deepAssign(merged, parsed);
    return merged;
  }catch(_){
    return structuredClone(defaultState);
  }
}
let state = loadState();
function saveState(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(_){} }

/* ============================================================
  THEMES: 2 modes visuels + 4 saisons (nature, pas de mauve)
  -> On utilise CSS (data-theme + data-season) dans PARTIE 1
============================================================ */
const SEASONS = ["printemps","ete","automne","hiver"];
const THEMES  = ["pastel-light","pastel-dark"];

function applyTheme(){
  document.body.dataset.theme  = state.ui.theme;
  document.body.dataset.season = state.ui.season;

  // labels topbar
  if($("themeLbl"))  $("themeLbl").textContent  = (state.ui.theme==="pastel-dark") ? "pastel foncé" : "pastel clair";
  if($("seasonLbl")) $("seasonLbl").textContent = state.ui.season;

  // progress size override if asked
  if(state.ui.progressH){
    document.documentElement.style.setProperty("--progressH", state.ui.progressH);
  } else {
    document.documentElement.style.removeProperty("--progressH");
  }

  // panel width
  document.documentElement.style.setProperty("--drawerW", `${clamp(state.ui.leftW, 320, 980)}px`);
  document.documentElement.style.setProperty("--rightW",  `${clamp(state.ui.rightW, 320, 980)}px`);

  // reduce motion
  const rm = !!state.ui.reduceMotion || isReduced();
  document.body.dataset.reduceMotion = rm ? "1" : "0";
}

/* ============================================================
  PANELS open/close + resizers
============================================================ */
function panelOpen(which, open){
  const p = $(which==="left" ? "leftPanel" : "rightPanel");
  const b = $(which==="left" ? "leftBack"  : "rightBack");
  if(!p || !b) return;
  p.classList.toggle("open", !!open);
  b.classList.toggle("show", !!open);
}
function initPanelResizer(which){
  const handle = $(which==="left" ? "leftResizer" : "rightResizer");
  if(!handle) return;
  let drag=false, sx=0, sw=0;

  const down = (x)=>{
    drag=true; sx=x;
    sw = which==="left" ? (state.ui.leftW||420) : (state.ui.rightW||560);
    handle.setPointerCapture?.(0);
  };
  const move = (x)=>{
    if(!drag) return;
    const dx = x - sx;
    if(which==="left"){
      state.ui.leftW = clamp(sw + dx, 320, 980);
    }else{
      state.ui.rightW = clamp(sw - dx, 320, 980);
    }
    applyTheme();
  };
  const up = ()=>{
    if(!drag) return;
    drag=false;
    saveState();
  };

  handle.addEventListener("mousedown",(e)=>{ e.preventDefault(); down(e.clientX); });
  window.addEventListener("mousemove",(e)=>move(e.clientX));
  window.addEventListener("mouseup",up);

  handle.addEventListener("touchstart",(e)=>{ e.preventDefault(); down(e.touches[0].clientX); }, {passive:false});
  window.addEventListener("touchmove",(e)=>move(e.touches[0].clientX), {passive:true});
  window.addEventListener("touchend",up);
}

/* ============================================================
  FX: confetti + pollen (canvas)
============================================================ */
const fx = {
  conf:{ ctx:null, pieces:[], raf:null },
  pollen:{ ctx:null, seeds:[], raf:null }
};

function setupCanvas(id){
  const c = $(id);
  if(!c) return null;
  const ctx = c.getContext("2d");
  const resize = ()=>{
    const dpr = window.devicePixelRatio || 1;
    c.width = Math.floor(window.innerWidth * dpr);
    c.height = Math.floor(window.innerHeight * dpr);
    c.style.width = window.innerWidth+"px";
    c.style.height = window.innerHeight+"px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
  };
  window.addEventListener("resize", resize);
  resize();
  return ctx;
}
function initFX(){
  fx.conf.ctx = setupCanvas("confetti");
  fx.pollen.ctx = setupCanvas("pollen");
  startPollen();
}

function confettiBurst(power=1){
  if(!fx.conf.ctx) return;
  if(document.body.dataset.reduceMotion==="1") return;
  const ctx = fx.conf.ctx;
  const n = Math.floor(140*power);
  const cx = window.innerWidth/2;
  const cy = window.innerHeight*0.22;

  for(let i=0;i<n;i++){
    fx.conf.pieces.push({
      x:cx, y:cy,
      vx:(Math.random()-0.5)*10*power,
      vy:(Math.random()-0.9)*16*power,
      g:(0.25+Math.random()*0.22)*(0.9+power*0.2),
      s:2+Math.random()*4*power,
      life: 70+Math.random()*70,
      rot: Math.random()*Math.PI,
      vr:(Math.random()-0.5)*0.35
    });
  }
  if(!fx.conf.raf) fx.conf.raf = requestAnimationFrame(confLoop);

  function confLoop(){
    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    fx.conf.pieces = fx.conf.pieces.filter(p=>p.life>0);

    const fg = getComputedStyle(document.documentElement).getPropertyValue("--fg").trim() || "#000";
    ctx.fillStyle = fg;
    ctx.globalAlpha = 0.86;

    for(const p of fx.conf.pieces){
      p.vy += p.g;
      p.x += p.vx; p.y += p.vy;
      p.rot += p.vr;
      p.life -= 1;

      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.rot);
      ctx.fillRect(-p.s,-p.s,p.s*2,p.s*2);
      ctx.restore();
    }
    ctx.globalAlpha = 1;

    if(fx.conf.pieces.length){
      fx.conf.raf = requestAnimationFrame(confLoop);
    }else{
      cancelAnimationFrame(fx.conf.raf);
      fx.conf.raf = null;
      ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    }
  }
}

function startPollen(){
  if(!fx.pollen.ctx) return;
  const ctx = fx.pollen.ctx;

  const rm = document.body.dataset.reduceMotion==="1";
  if(rm){
    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    if(fx.pollen.raf){ cancelAnimationFrame(fx.pollen.raf); fx.pollen.raf=null; }
    return;
  }

  const makeSeed = ()=>({
    x:Math.random()*window.innerWidth,
    y:Math.random()*window.innerHeight,
    r:0.7+Math.random()*2.0,
    a:0.07+Math.random()*0.16,
    vx:(Math.random()*0.18+0.04)*(Math.random()<0.5?-1:1),
    vy:(Math.random()*0.22+0.04),
    wob:Math.random()*Math.PI*2,
    wobv:0.006+Math.random()*0.012
  });
  const target=72;
  while(fx.pollen.seeds.length<target) fx.pollen.seeds.push(makeSeed());

  const loop = ()=>{
    if(document.body.dataset.reduceMotion==="1"){
      ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
      fx.pollen.raf=null;
      return;
    }
    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);

    const halo = getComputedStyle(document.documentElement).getPropertyValue("--accent2").trim() || "rgba(0,0,0,.12)";
    ctx.fillStyle = halo;

    for(const s of fx.pollen.seeds){
      s.wob += s.wobv;
      s.x += s.vx + Math.sin(s.wob)*0.25;
      s.y += s.vy;

      if(s.y>window.innerHeight+20){ s.y=-20; s.x=Math.random()*window.innerWidth; }
      if(s.x<-20) s.x=window.innerWidth+20;
      if(s.x>window.innerWidth+20) s.x=-20;

      ctx.globalAlpha = s.a;
      ctx.beginPath();
      ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    fx.pollen.raf = requestAnimationFrame(loop);
  };
  if(!fx.pollen.raf) fx.pollen.raf = requestAnimationFrame(loop);
}

/* ============================================================
  MODALS
============================================================ */
function openModal(id){
  const back = $("modalBack");
  const el = $(id);
  if(!back || !el) return;
  back.classList.add("show");
  el.classList.add("show");
}
function closeModal(id){
  const el = $(id);
  if(el) el.classList.remove("show");
  const back = $("modalBack");
  if(back && $$(".modal.show").length===0) back.classList.remove("show");
}
function closeAllModals(){
  $$(".modal.show").forEach(m=>m.classList.remove("show"));
  const back = $("modalBack");
  if(back) back.classList.remove("show");
}
function bindModalClose(){
  const back = $("modalBack");
  if(back) back.addEventListener("click", closeAllModals);
  $$(".modal").forEach(m=>{
    m.addEventListener("click",(e)=>{ if(e.target===m) closeAllModals(); });
  });
}

/* ============================================================
  TASKS: import, baseline, progress, current, list
============================================================ */
function isAllCapsLine(line){
  const t = (line||"").trim();
  if(!t) return false;
  const hasLetters = /[A-Za-zÀ-ÖØ-öø-ÿ]/.test(t);
  if(!hasLetters) return false;
  return t === t.toUpperCase() && t.length <= 90;
}
function parseTaskLine(line){
  const raw = (line||"").trim();
  if(!raw) return null;
  const cleaned = raw.replace(/^[-*•\s]+/, "").trim();
  if(!cleaned) return null;

  let et = null;
  let title = cleaned;
  const m = cleaned.match(/^(.*?)(?:\s*[-–—]\s*|\s+)(\d+)\s*$/);
  if(m){
    title = m[1].trim();
    et = clamp(parseInt(m[2],10)||1, 1, 99);
  }
  title = title.replace(/\s+/g," ").trim();
  if(!title) return null;

  return { title, etorions: et ?? 1 };
}
function importFromInbox(text){
  const lines = String(text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  let cat = "Inbox";
  const out = [];
  for(const line of lines){
    if(isAllCapsLine(line)){ cat = line.trim(); continue; }
    const p = parseTaskLine(line);
    if(!p) continue;
    out.push({
      id: uid(),
      title: p.title,
      cat,
      etorionsTotal: p.etorions,
      etorionsLeft: p.etorions,
      pinned:false,
      done:false,
      createdAt: nowISO(),
      doneAt:null
    });
  }
  return out;
}

function activeTasks(){ return state.tasks.filter(t=>!t.done); }
function doneTasks(){ return state.tasks.filter(t=>t.done); }
function getTask(id){ return state.tasks.find(t=>t.id===id) || null; }

function sortTasks(list){
  return [...list].sort((a,b)=>{
    if(a.pinned && !b.pinned) return -1;
    if(!a.pinned && b.pinned) return 1;
    return String(a.createdAt||"").localeCompare(String(b.createdAt||""));
  });
}

function ensureBaseline(force=false){
  if(!state.baseline) state.baseline = { totalTasks:0, totalEtorions:0 };
  if(force || (state.baseline.totalTasks===0 && state.tasks.length>0)){
    const act = activeTasks();
    state.baseline.totalTasks = act.length;
    state.baseline.totalEtorions = act.reduce((a,t)=>a+(t.etorionsTotal||0),0);
  }
}
function ensureCurrentTask(){
  const act = sortTasks(activeTasks());
  if(act.length===0){ state.currentTaskId=null; return; }
  const cur = getTask(state.currentTaskId);
  if(!cur || cur.done){
    const pinned = act.find(t=>t.pinned);
    state.currentTaskId = (pinned||act[0]).id;
  }
}
function computeProgress(){
  const baseT = state.baseline.totalTasks || 0;
  const baseE = state.baseline.totalEtorions || 0;
  const rem = activeTasks();
  const remT = rem.length;
  const remE = rem.reduce((a,t)=>a+(t.etorionsLeft||0),0);

  const pct = (baseT<=0) ? 100 : clamp(Math.round((remT/baseT)*100), 0, 100);
  return { baseT, baseE, remT, remE, pct };
}

function pushUndo(label){
  state.undo.unshift({
    label, at:Date.now(),
    payload:{
      tasks: structuredClone(state.tasks),
      baseline: structuredClone(state.baseline),
      currentTaskId: state.currentTaskId,
      stats: structuredClone(state.stats),
      pomodoro: structuredClone(state.pomodoro)
    }
  });
  state.undo = state.undo.slice(0,18);
}
function undo(){
  const snap = state.undo.shift();
  if(!snap || !snap.payload) return;
  state.tasks = snap.payload.tasks || state.tasks;
  state.baseline = snap.payload.baseline || state.baseline;
  state.currentTaskId = snap.payload.currentTaskId ?? state.currentTaskId;
  state.stats = snap.payload.stats || state.stats;
  state.pomodoro = snap.payload.pomodoro || state.pomodoro;
  saveState();
  renderAll();
}

function degommeEtorion(){
  const t = getTask(state.currentTaskId);
  if(!t || t.done) return;
  pushUndo("etorion");
  t.etorionsLeft = clamp((t.etorionsLeft??t.etorionsTotal??1)-1, 0, 99);
  state.stats.etorionsDone = (state.stats.etorionsDone||0) + 1;

  if(t.etorionsLeft<=0){
    completeTask(t.id);
    return;
  }
  saveState();
  renderAll();
}
function completeTask(id){
  const t = getTask(id);
  if(!t || t.done) return;
  pushUndo("complete");
  t.done=true; t.doneAt=nowISO();
  state.stats.tasksDone = (state.stats.tasksDone||0) + 1;

  confettiBurst(1.1);

  ensureCurrentTask();
  saveState();
  renderAll();

  if(activeTasks().length===0 && state.baseline.totalTasks>0){
    bigFiesta();
  }
}
function deleteTask(id){
  const t = getTask(id);
  if(!t) return;
  pushUndo("delete");
  state.tasks = state.tasks.filter(x=>x.id!==id);
  ensureBaseline(true);
  ensureCurrentTask();
  saveState();
  renderAll();
}

/* ============================================================
  TIMER global (simple)
============================================================ */
function timerNowMs(){
  if(!state.timer.startedAt) return 0;
  const now = Date.now();
  const paused = state.timer.pausedTotal || 0;
  const extraPaused = state.timer.pausedAt ? (now - state.timer.pausedAt) : 0;
  return Math.max(0, now - state.timer.startedAt - paused - extraPaused);
}
function toggleGlobalPause(){
  if(!state.timer.startedAt) state.timer.startedAt = Date.now();
  if(state.timer.pausedAt){
    state.timer.pausedTotal = (state.timer.pausedTotal||0) + (Date.now()-state.timer.pausedAt);
    state.timer.pausedAt = null;
  }else{
    state.timer.pausedAt = Date.now();
  }
  saveState();
}

/* ============================================================
  POMODORO (intégré sous la barre)
============================================================ */
function pomodoroLeftMs(){
  if(!state.pomodoro.running) return null;
  if(state.pomodoro.paused && typeof state.pomodoro.pausedLeftMs==="number") return state.pomodoro.pausedLeftMs;
  if(!state.pomodoro.endsAt) return null;
  return Math.max(0, state.pomodoro.endsAt - Date.now());
}
function pomodoroStart(){
  const min = clamp(parseInt(state.pomodoro.minutes,10)||25, 5, 90);
  state.pomodoro.minutes = min;
  state.pomodoro.running = true;
  state.pomodoro.paused = false;
  state.pomodoro.pausedLeftMs = null;
  state.pomodoro.endsAt = Date.now() + min*60*1000;
  saveState();
  renderPomodoro();
}
function pomodoroPauseToggle(){
  if(!state.pomodoro.running) return;
  if(!state.pomodoro.paused){
    state.pomodoro.paused = true;
    state.pomodoro.pausedLeftMs = pomodoroLeftMs() ?? (state.pomodoro.minutes*60*1000);
    state.pomodoro.endsAt = null;
  }else{
    state.pomodoro.paused = false;
    const left = clamp(state.pomodoro.pausedLeftMs||0, 0, 90*60*1000);
    state.pomodoro.endsAt = Date.now() + left;
    state.pomodoro.pausedLeftMs = null;
  }
  saveState();
  renderPomodoro();
}
function pomodoroStop(){
  state.pomodoro.running=false;
  state.pomodoro.paused=false;
  state.pomodoro.endsAt=null;
  state.pomodoro.pausedLeftMs=null;
  saveState();
  renderPomodoro();
}

function renderPomodoro(){
  const timeEl = $("pomoTime");
  const hintEl = $("pomoHint");
  const btnStart = $("btnPomoStart");
  const btnStop  = $("btnPomoStop");
  const btnToggle= $("btnPomoToggle");

  if(btnToggle) btnToggle.textContent = state.pomodoro.visible ? "masquer" : "afficher";
  if(!state.ui.showPomodoro){
    if(timeEl) timeEl.textContent = "";
    if(hintEl) hintEl.textContent = "";
    return;
  }
  // visible toggle affects only row; Part 1 should hide via CSS class if you have it. Here we just dim.
  const row = $("pomoClickZone")?.closest(".pomoRow");
  if(row) row.style.display = state.pomodoro.visible ? "" : "none";

  const left = pomodoroLeftMs();
  if(!state.pomodoro.running){
    if(timeEl) timeEl.textContent = `${String(state.pomodoro.minutes).padStart(2,"0")}:00`;
    if(hintEl) hintEl.textContent = "pomodoro prêt";
    if(btnStart) btnStart.textContent = "start";
    if(btnStop) btnStop.style.display = "none";
  }else{
    if(timeEl) timeEl.textContent = formatMMSS(left||0);
    if(hintEl) hintEl.textContent = state.pomodoro.paused ? "pomodoro (pause)" : "pomodoro (en cours)";
    if(btnStart) btnStart.textContent = state.pomodoro.paused ? "reprendre" : "pause";
    if(btnStop) btnStop.style.display = "";
  }
}

/* ============================================================
  TAGLINES: conquérant, fin, pas niais
============================================================ */
const TAGLINES = [
  "Un pas. Une coupe nette. Rien ne discute.",
  "Le chaos signe. Tu avances.",
  "L’armée des “plus tard” recule. Tu prends le terrain.",
  "Aujourd’hui: calme, précis, implacable.",
  "Ton royaume n’a pas demandé à être conquis. Tant pis."
];
function maybeNewTagline(){
  if(!state.ui.showTagline) return;
  const el = $("tagline");
  if(!el) return;
  if(!el.textContent.trim() || Math.random()<0.25){
    el.textContent = TAGLINES[Math.floor(Math.random()*TAGLINES.length)];
  }
}

/* ============================================================
  BELOW LIST (liste en cours sous la zone centrale)
============================================================ */
function renderBelowList(){
  const box = $("belowRows");
  const wrap = $("belowList");
  if(!box || !wrap) return;

  wrap.classList.toggle("show", !!state.ui.showBelowList);

  const list = sortTasks(activeTasks());
  if(list.length===0){
    box.innerHTML = `<div class="muted">Aucune tâche.</div>`;
    return;
  }

  box.innerHTML = list.slice(0,80).map(t=>{
    const et = t.etorionsTotal||1;
    const left = t.etorionsLeft ?? et;
    const cur = (t.id===state.currentTaskId);
    return `
      <div class="listRow ${cur?"isCurrent":""}">
        <div class="t" title="${escapeHTML(t.title)}">${escapeHTML(t.title)}</div>
        <div class="m">${left}/${et}</div>
        <div class="tools">
          <div class="tool" data-act="pin" data-id="${t.id}" title="prioriser">${t.pinned ? "prio" : "prio"}</div>
          <div class="tool" data-act="go"  data-id="${t.id}" title="cibler">go</div>
          <div class="tool" data-act="edit"data-id="${t.id}" title="éditer">edit</div>
          <div class="tool" data-act="done"data-id="${t.id}" title="finir">fin</div>
          <div class="tool" data-act="del" data-id="${t.id}" title="supprimer">x</div>
        </div>
      </div>
    `;
  }).join("");

  $$(".tool", box).forEach(b=>{
    b.onclick = ()=>{
      const id = b.getAttribute("data-id");
      const act = b.getAttribute("data-act");
      const t = getTask(id);
      if(!t) return;

      if(act==="pin"){ pushUndo("pin"); t.pinned=!t.pinned; }
      if(act==="go"){ state.currentTaskId=id; }
      if(act==="done"){ completeTask(id); return; }
      if(act==="del"){ deleteTask(id); return; }
      if(act==="edit"){ openTaskEditor(id); return; }

      saveState();
      renderAll();
    };
  });
}

/* ============================================================
  TASK EDIT MODAL
============================================================ */
function openTaskEditor(id){
  const t = getTask(id);
  if(!t) return;
  const host = $("taskEditBody");
  if(!host) return;

  host.innerHTML = `
    <div class="section">
      <h3>Modifier</h3>
      <div class="row">
        <input id="teTitle" value="${escapeHTML(t.title)}" placeholder="Titre">
        <input id="teCat" value="${escapeHTML(t.cat||"Inbox")}" placeholder="Catégorie">
      </div>
      <div class="row">
        <input id="teTotal" type="number" min="1" max="99" step="1" value="${t.etorionsTotal||1}">
        <input id="teLeft" type="number" min="0" max="99" step="1" value="${t.etorionsLeft ?? (t.etorionsTotal||1)}">
      </div>
      <div class="row">
        <button class="btn" id="teSave">enregistrer</button>
        <button class="btn" id="teCancel">annuler</button>
      </div>
    </div>
  `;

  $("teSave").onclick = ()=>{
    pushUndo("edit");
    t.title = ($("teTitle").value||"").trim() || t.title;
    t.cat   = ($("teCat").value||"").trim()   || t.cat;
    t.etorionsTotal = clamp(parseInt($("teTotal").value,10)||1, 1, 99);
    t.etorionsLeft  = clamp(parseInt($("teLeft").value,10)||t.etorionsTotal, 0, 99);
    saveState();
    closeModal("taskEditModal");
    renderAll();
  };
  $("teCancel").onclick = ()=>closeModal("taskEditModal");

  openModal("taskEditModal");
}

/* ============================================================
  FOCUS MODE (overlay)
============================================================ */
function enterFocus(){
  state.ui.focus = true;
  saveState();
  renderAll();
}
function exitFocus(){
  state.ui.focus = false;
  saveState();
  renderAll();
}
function renderFocus(){
  const ov = $("focusOverlay");
  if(!ov) return;
  ov.style.display = state.ui.focus ? "block" : "none";

  const p = computeProgress();
  if($("fBarFill")) $("fBarFill").style.width = `${p.pct}%`;
  if($("fBarPct"))  $("fBarPct").textContent = `${p.pct}%`;

  const t = getTask(state.currentTaskId);
  if($("fTaskName")) $("fTaskName").textContent = t ? t.title : "Aucune tâche";

  if($("fChips")){
    if(!t){ $("fChips").innerHTML=""; }
    else{
      const total=t.etorionsTotal||1;
      const left=t.etorionsLeft ?? total;
      $("fChips").innerHTML = Array.from({length:total},(_,i)=>`<span class="chip ${i<left?"on":""}"></span>`).join("");
    }
  }

  // pomodoro mirror
  if($("fPomoTime")){
    const left = pomodoroLeftMs();
    if(!state.pomodoro.running) $("fPomoTime").textContent = `${String(state.pomodoro.minutes).padStart(2,"0")}:00`;
    else $("fPomoTime").textContent = formatMMSS(left||0);
  }
  if($("fPomoHint")){
    if(!state.pomodoro.running) $("fPomoHint").textContent="pomodoro";
    else $("fPomoHint").textContent = state.pomodoro.paused ? "pomodoro (pause)" : "pomodoro";
  }
  if($("fPomoStart")){
    if(!state.pomodoro.running) $("fPomoStart").textContent="start";
    else $("fPomoStart").textContent = state.pomodoro.paused ? "reprendre" : "pause";
  }
  if($("fPomoStop")){
    $("fPomoStop").style.display = state.pomodoro.running ? "" : "none";
  }
}

/* ============================================================
  KIFFANCE (surprise)
============================================================ */
function seedKiffanceIfEmpty(){
  const b = state.kiffance.bank;
  const empty = ["5","10","15","25"].every(k=>Array.isArray(b[k]) && b[k].length===0);
  if(!empty) return;

  b["5"] = [
    "Respire 5 cycles. Mâchoire déverrouillée. Tu reviens en mode ninja calme.",
    "Bois de l’eau comme un druide qui connaît l’avenir. Une gorgée = un sort.",
    "Étire nuque/épaules 60 secondes. Déplie tes ailes invisibles.",
    "Marche 45 secondes comme un héros de JRPG. Oui, même dans le couloir.",
    "Regarde dehors 30 secondes. Le monde existe encore. Étonnant."
  ];
  b["10"] = [
    "Reset noble: eau + fenêtre 2 min + retour.",
    "Mini-rangement 6 min. Tu purifies une zone. Le chaos recule.",
    "Marche 8 min sans écran. Reviens avec une seule intention.",
    "Snack simple. Aucun scroll. Tu es un moine guerrier."
  ];
  b["15"] = [
    "Respiration 4-6 (4 min) + étirements (8 min) + retour (3 min).",
    "Musique douce + rangement 12 min + 3 min reprise lente.",
    "Douche rapide (ou nuque/visage) + retour propre."
  ];
  b["25"] = [
    "Pause ‘Ghibli’: thé, lumière, silence 20 min + 5 min reprise.",
    "Micro-sieste 15–20 min + eau + reprise.",
    "Marche dehors + tu écris UNE priorité en revenant."
  ];
  saveState();
}

function pickKiffance(){
  const enabled = state.kiffance.enabledBuckets.filter(k=>Array.isArray(state.kiffance.bank[k]) && state.kiffance.bank[k].length>0);
  if(!enabled.length) return null;
  const bucket = enabled[Math.floor(Math.random()*enabled.length)];
  const arr = state.kiffance.bank[bucket];
  return { bucket, text: arr[Math.floor(Math.random()*arr.length)] };
}

function showKiffance(){
  const pick = pickKiffance();
  if(!pick){
    $("celeTitle").textContent = "Kiffance";
    $("celeMsg").textContent = "Banque vide. Ajoute des kiffances dans le panneau.";
    $("celeSub").textContent = "";
    openModal("celeModal");
    return;
  }
  state.kiffance.lastPickAt = Date.now();
  saveState();

  $("celeTitle").textContent = `Kiffance (${pick.bucket} min)`;
  $("celeMsg").textContent = pick.text;
  $("celeSub").textContent = "Surprise. Respire. Puis retour au royaume.";
  openModal("celeModal");
}

/* ============================================================
  BIG FIESTA + auto-gratification
============================================================ */
const GLORY = [
  "GLORIEUX. Tu as plié la réalité en origami.",
  "Victoire totale. Les tâches ont fui en silence.",
  "Le chaos a signé. Tu es officiellement inévitable.",
  "Le conseil des anciens valide: tu es une machine élégante.",
  "Ton empire administratif est désormais pacifié."
];
function bigFiesta(){
  confettiBurst(1.9);
  $("celeTitle").textContent = "Mission totale";
  $("celeMsg").textContent = GLORY[Math.floor(Math.random()*GLORY.length)];
  $("celeSub").textContent = "Clique pour fermer. Savoure 3 secondes. Oui, c’est un ordre.";
  openModal("celeModal");
}

/* ============================================================
  NOTES
============================================================ */
function renderNotes(){
  const host = $("notesList");
  if(!host) return;
  if(!state.notes.length){
    host.innerHTML = `<div class="muted">Aucune note.</div>`;
    return;
  }
  host.innerHTML = state.notes.slice(0,40).map(n=>{
    return `<div class="listRow"><div class="t">${escapeHTML(n.text)}</div><div class="m">${escapeHTML(n.at.slice(0,16).replace("T"," "))}</div></div>`;
  }).join("");
}
function addNote(text){
  const t = String(text||"").trim();
  if(!t) return;
  state.notes.unshift({ id:uid(), at:nowISO(), text:t });
  state.notes = state.notes.slice(0,120);
  saveState();
  renderNotes();
}

/* ============================================================
  EXPORT (texte)
============================================================ */
function exportText(){
  ensureBaseline(false);
  const p = computeProgress();
  const done = p.baseT - p.remT;

  const lines = [];
  lines.push("ELIMINATOR — export texte");
  lines.push(`Date: ${dayKey()}`);
  lines.push(`Tâches: ${done}/${p.baseT} (reste ${p.remT})`);
  lines.push(`Étorions: ${state.stats.etorionsDone||0}/${p.baseE} (reste ${p.remE})`);
  lines.push(`Chrono: ${formatMMSS(timerNowMs())}`);
  lines.push("");

  const act = sortTasks(activeTasks());
  const byCat = {};
  act.forEach(t=>{ (byCat[t.cat||"Inbox"] ||= []).push(t); });

  Object.keys(byCat).sort().forEach(cat=>{
    lines.push(cat);
    byCat[cat].forEach(t=>{
      const et = t.etorionsTotal||1;
      const left = t.etorionsLeft ?? et;
      lines.push(`- ${t.title} (${left}/${et})${t.pinned?" [priorité]":""}`);
    });
    lines.push("");
  });

  const doneList = doneTasks().slice().sort((a,b)=>String(b.doneAt||"").localeCompare(String(a.doneAt||""))).slice(0,25);
  if(doneList.length){
    lines.push("Finies (25 dernières)");
    doneList.forEach(t=>lines.push(`- ${t.title}`));
  }
  return lines.join("\n");
}

/* ============================================================
  RIGHT PANEL: minimal render (sets/habits/mood/calendar/stats)
  (Version compacte: on ne refait pas 6000 lignes ici, mais c'est fonctionnel)
============================================================ */
function seedSetsHabitsIfEmpty(){
  if(!Array.isArray(state.sets.list)) state.sets.list=[];
  if(state.sets.list.length===0){
    const mk=(title, unitName, unitCount, items)=>({
      id:uid(), title, unitName, unitCount, items,
      checks:{}, order:Date.now()+Math.random()
    });
    state.sets.list = [
      mk("Set 1","Patient",4,["Voir","Note","Traitement","Dossier"]),
      mk("Set 2","Patient",6,["Voir","Note","Ordonnance","Dossier"])
    ];
    state.sets.selectedId = state.sets.list[0].id;
  }
  if(!Array.isArray(state.habits)) state.habits=[];
  if(state.habits.length===0){
    state.habits = [
      { id:uid(), name:"Eau", slots:8, checks:Array.from({length:8},()=>false), createdAt:nowISO() },
      { id:uid(), name:"Marche", slots:4, checks:Array.from({length:4},()=>false), createdAt:nowISO() },
      { id:uid(), name:"Lecture", slots:3, checks:Array.from({length:3},()=>false), createdAt:nowISO() }
    ];
  }
  saveState();
}
function getSet(id){ return state.sets.list.find(s=>s.id===id)||null; }
function ensureSelectedSet(){
  if(state.sets.list.length===0){ state.sets.selectedId=null; return; }
  if(!state.sets.selectedId || !getSet(state.sets.selectedId)) state.sets.selectedId = state.sets.list[0].id;
}
function initSetDay(set, day=dayKey()){
  set.checks ||= {};
  if(!set.checks[day]) set.checks[day]={};
}
function setCheckKey(u,i){ return `u${u}_i${i}`; }

function renderRightPanel(){
  const tabs = $("rightTabs");
  const body = $("rightBody");
  if(!tabs || !body) return;

  state.ui.rightTab ||= "sets";
  const tab = state.ui.rightTab;

  tabs.innerHTML = `
    <button class="tab ${tab==="sets"?"active":""}" data-t="sets">sets</button>
    <button class="tab ${tab==="habits"?"active":""}" data-t="habits">habitudes</button>
    <button class="tab ${tab==="stats"?"active":""}" data-t="stats">stats</button>
    <button class="tab ${tab==="prefs"?"active":""}" data-t="prefs">préférences</button>
  `;
  $$(".tab", tabs).forEach(b=>{
    b.onclick = ()=>{
      state.ui.rightTab = b.getAttribute("data-t");
      saveState();
      renderRightPanel();
    };
  });

  body.innerHTML = "";
  ensureSelectedSet();

  if(tab==="sets") body.appendChild(viewSets());
  if(tab==="habits") body.appendChild(viewHabits());
  if(tab==="stats") body.appendChild(viewStats());
  if(tab==="prefs") body.appendChild(viewPrefs());
}

function viewSets(){
  const wrap=document.createElement("div");
  wrap.className="section";
  const set = getSet(state.sets.selectedId);

  wrap.innerHTML = `
    <h3>sets</h3>
    <div class="row">
      <button class="btn" id="setAdd">nouveau</button>
      <button class="btn" id="setEdit">éditer</button>
      <select id="setPick"></select>
    </div>
    <div style="height:10px"></div>
    <div id="setChecklist"></div>
  `;

  const sel = wrap.querySelector("#setPick");
  sel.innerHTML = state.sets.list.slice().sort((a,b)=>(a.order||0)-(b.order||0)).map(s=>(
    `<option value="${s.id}" ${s.id===state.sets.selectedId?"selected":""}>${escapeHTML(s.title)}</option>`
  )).join("");
  sel.onchange = ()=>{
    state.sets.selectedId = sel.value;
    saveState();
    renderRightPanel();
  };

  wrap.querySelector("#setAdd").onclick = ()=>{
    const s = { id:uid(), title:`Set ${state.sets.list.length+1}`, unitName:"Patient", unitCount:3, items:["Voir","Note","Traitement","Dossier"], checks:{}, order:Date.now()+Math.random() };
    state.sets.list.push(s);
    state.sets.selectedId = s.id;
    saveState();
    renderRightPanel();
  };

  wrap.querySelector("#setEdit").onclick = ()=>{
    openModal("setEditModal");
    renderSetEditor();
  };

  const host = wrap.querySelector("#setChecklist");
  if(!set){ host.innerHTML = `<div class="muted">Aucun set.</div>`; return wrap; }

  const day = dayKey();
  initSetDay(set, day);
  const checks = set.checks[day];

  let html = "";
  for(let u=0; u<set.unitCount; u++){
    html += `<div style="margin:10px 0 6px; font-weight:900;">${escapeHTML(set.unitName)} ${u+1}</div>`;
    for(let i=0;i<set.items.length;i++){
      const k=setCheckKey(u,i);
      const on=!!checks[k];
      html += `
        <button class="opt ${on?"on":""}" data-u="${u}" data-i="${i}" style="width:100%; justify-content:flex-start;">
          <span class="dot"></span>
          <span>${escapeHTML(set.items[i])}</span>
        </button>
      `;
    }
  }
  host.innerHTML = html;
  $$(".opt", host).forEach(b=>{
    b.onclick = ()=>{
      const u=parseInt(b.getAttribute("data-u"),10);
      const i=parseInt(b.getAttribute("data-i"),10);
      const k=setCheckKey(u,i);
      checks[k] = !checks[k];
      saveState();
      renderRightPanel();
    };
  });

  return wrap;
}

function renderSetEditor(){
  const host = $("setEditBody");
  if(!host) return;
  const set = getSet(state.sets.selectedId);
  if(!set){ host.innerHTML = `<div class="muted">Aucun set sélectionné.</div>`; return; }

  host.innerHTML = `
    <div class="section">
      <h3>éditer set</h3>
      <div class="row">
        <input id="seTitle" value="${escapeHTML(set.title)}" placeholder="Titre">
        <input id="seUnit" value="${escapeHTML(set.unitName)}" placeholder="Nom unité">
      </div>
      <div class="row">
        <input id="seCount" type="number" min="1" max="30" step="1" value="${set.unitCount}">
        <button class="btn" id="seReset">reset jour</button>
      </div>
      <textarea id="seItems" style="min-height:180px">${escapeHTML(set.items.join("\n"))}</textarea>
      <div class="row">
        <button class="btn" id="seSave">enregistrer</button>
        <button class="btn" id="seClose">fermer</button>
        <button class="btn" id="seDel">supprimer</button>
      </div>
    </div>
  `;

  $("seSave").onclick = ()=>{
    set.title = ($("seTitle").value||"").trim() || set.title;
    set.unitName = ($("seUnit").value||"").trim() || set.unitName;
    set.unitCount = clamp(parseInt($("seCount").value,10)||set.unitCount, 1, 30);
    set.items = ($("seItems").value||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean).slice(0,40);
    saveState();
    closeModal("setEditModal");
    renderRightPanel();
  };
  $("seClose").onclick = ()=>closeModal("setEditModal");
  $("seReset").onclick = ()=>{
    initSetDay(set, dayKey());
    set.checks[dayKey()] = {};
    saveState();
    renderRightPanel();
  };
  $("seDel").onclick = ()=>{
    if(!confirm("Supprimer ce set ?")) return;
    state.sets.list = state.sets.list.filter(s=>s.id!==set.id);
    ensureSelectedSet();
    saveState();
    closeModal("setEditModal");
    renderRightPanel();
  };
}

function viewHabits(){
  const wrap=document.createElement("div");
  wrap.className="section";
  wrap.innerHTML = `<h3>habitudes</h3><div id="habList"></div><div class="row"><button class="btn" id="habAdd">ajouter</button></div>`;
  const host = wrap.querySelector("#habList");
  if(!state.habits.length){
    host.innerHTML = `<div class="muted">Aucune habitude.</div>`;
  } else {
    host.innerHTML = state.habits.map(h=>{
      const done = (h.checks||[]).filter(Boolean).length;
      const tot = (h.checks||[]).length;
      const chips = (h.checks||[]).map((v,i)=>`<button class="chip ${v?"on":""}" data-h="${h.id}" data-i="${i}" title="toggle"></button>`).join("");
      return `
        <div class="section" style="margin:10px 0; padding:10px;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:950;">${escapeHTML(h.name)}</div>
            <div class="muted">${done}/${tot}</div>
          </div>
          <div class="chips" style="justify-content:flex-start; margin:8px 0;">${chips}</div>
          <div class="row">
            <button class="btn" data-act="reset" data-h="${h.id}">reset</button>
            <button class="btn" data-act="del" data-h="${h.id}">supprimer</button>
          </div>
        </div>
      `;
    }).join("");
  }

  setTimeout(()=>{
    $$(".chip", host).forEach(b=>{
      b.onclick=()=>{
        const hId=b.getAttribute("data-h");
        const idx=parseInt(b.getAttribute("data-i"),10);
        const h = state.habits.find(x=>x.id===hId);
        if(!h) return;
        h.checks[idx]=!h.checks[idx];
        saveState();
        renderRightPanel();
      };
    });
    $$("button[data-act]", host).forEach(b=>{
      b.onclick=()=>{
        const act=b.getAttribute("data-act");
        const hId=b.getAttribute("data-h");
        const h = state.habits.find(x=>x.id===hId);
        if(!h) return;
        if(act==="reset") h.checks = h.checks.map(()=>false);
        if(act==="del"){
          if(!confirm("Supprimer cette habitude ?")) return;
          state.habits = state.habits.filter(x=>x.id!==hId);
        }
        saveState();
        renderRightPanel();
      };
    });
    wrap.querySelector("#habAdd").onclick=()=>{
      const name = prompt("Nom habitude :", "Respiration");
      if(name===null) return;
      const slots = clamp(parseInt(prompt("Nombre de cases (3-12) :", "6")||"6",10), 3, 12);
      state.habits.unshift({ id:uid(), name:name.trim()||"Habitude", slots, checks:Array.from({length:slots},()=>false), createdAt:nowISO() });
      saveState();
      renderRightPanel();
    };
  },0);

  return wrap;
}

function viewStats(){
  const wrap=document.createElement("div");
  wrap.className="section";
  ensureBaseline(false);
  const p = computeProgress();
  wrap.innerHTML = `
    <h3>stats</h3>
    <div class="muted">Tâches faites: ${state.stats.tasksDone||0} · Étorions faits: ${state.stats.etorionsDone||0}</div>
    <div class="muted">Progression: ${p.pct}% · Reste: ${p.remT} tâches</div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="openExport">export</button>
      <button class="btn" id="clearDone">vider finies</button>
      <button class="btn" id="resetBaseline">reset baseline</button>
    </div>
  `;
  setTimeout(()=>{
    wrap.querySelector("#openExport").onclick=()=>{
      openModal("exportModal");
      if($("expOut")) $("expOut").value = exportText();
    };
    wrap.querySelector("#clearDone").onclick=()=>{
      if(!confirm("Supprimer toutes les tâches finies ?")) return;
      pushUndo("clearDone");
      state.tasks = state.tasks.filter(t=>!t.done);
      ensureBaseline(true);
      ensureCurrentTask();
      saveState();
      renderAll();
      renderRightPanel();
    };
    wrap.querySelector("#resetBaseline").onclick=()=>{
      pushUndo("baseline");
      ensureBaseline(true);
      saveState();
      renderAll();
      renderRightPanel();
    };
  },0);
  return wrap;
}

function viewPrefs(){
  const wrap=document.createElement("div");
  wrap.className="section";

  wrap.innerHTML = `
    <h3>préférences</h3>

    <div class="muted" style="margin-bottom:8px">Deux modes visuels, et les saisons comme palettes.</div>

    <div class="row">
      <button class="btn" id="prefTheme">${state.ui.theme==="pastel-dark"?"passer pastel clair":"passer pastel foncé"}</button>
      <button class="btn" id="prefSeason">saison: ${state.ui.season}</button>
    </div>

    <div style="height:8px"></div>

    <div class="row">
      <button class="btn" id="prefTagline">${state.ui.showTagline?"masquer phrase":"afficher phrase"}</button>
      <button class="btn" id="prefPomo">${state.ui.showPomodoro?"masquer pomodoro":"afficher pomodoro"}</button>
      <button class="btn" id="prefMotion">${(state.ui.reduceMotion||false)?"animations: off":"animations: on"}</button>
    </div>

    <div style="height:8px"></div>

    <div class="row">
      <button class="btn" id="prefBarBig">barre: plus grande</button>
      <button class="btn" id="prefBarDefault">barre: défaut</button>
    </div>

    <div style="height:8px"></div>

    <div class="row">
      <button class="btn" id="prefKiff">kiffance surprise</button>
    </div>
  `;

  setTimeout(()=>{
    wrap.querySelector("#prefTheme").onclick=()=>{
      state.ui.theme = (state.ui.theme==="pastel-dark") ? "pastel-light" : "pastel-dark";
      saveState(); applyTheme(); renderAll(); renderRightPanel();
    };
    wrap.querySelector("#prefSeason").onclick=()=>{
      const i = SEASONS.indexOf(state.ui.season);
      state.ui.season = SEASONS[(i+1)%SEASONS.length];
      saveState(); applyTheme(); renderAll(); renderRightPanel();
    };
    wrap.querySelector("#prefTagline").onclick=()=>{
      state.ui.showTagline = !state.ui.showTagline;
      saveState(); renderAll(); renderRightPanel();
    };
    wrap.querySelector("#prefPomo").onclick=()=>{
      state.ui.showPomodoro = !state.ui.showPomodoro;
      saveState(); renderAll(); renderRightPanel();
    };
    wrap.querySelector("#prefMotion").onclick=()=>{
      state.ui.reduceMotion = !state.ui.reduceMotion;
      saveState(); applyTheme(); startPollen(); renderAll(); renderRightPanel();
    };
    wrap.querySelector("#prefBarBig").onclick=()=>{
      // barre énorme (répond “trop petite”)
      state.ui.progressH = "clamp(180px, 26vh, 360px)";
      saveState(); applyTheme(); renderAll();
    };
    wrap.querySelector("#prefBarDefault").onclick=()=>{
      state.ui.progressH = null;
      saveState(); applyTheme(); renderAll();
    };
    wrap.querySelector("#prefKiff").onclick=()=>showKiffance();
  },0);

  return wrap;
}

/* ============================================================
  RENDER central UI
============================================================ */
function renderProgress(){
  ensureBaseline(false);
  const p = computeProgress();
  if($("barFill")) $("barFill").style.width = `${p.pct}%`;
  if($("barPct"))  $("barPct").textContent = `${p.pct}%`;
}
function renderCurrentTask(){
  ensureCurrentTask();
  const t = getTask(state.currentTaskId);

  if($("taskName")) $("taskName").textContent = t ? t.title : "Aucune tâche";

  if($("etorChips")){
    if(!t){ $("etorChips").innerHTML=""; }
    else{
      const total=t.etorionsTotal||1;
      const left=t.etorionsLeft ?? total;
      $("etorChips").innerHTML = Array.from({length:total},(_,i)=>`<span class="chip ${i<left?"on":""}"></span>`).join("");
    }
  }

  // HUD pill
  const p = computeProgress();
  if($("hudPill")){
    const chrono = formatMMSS(timerNowMs());
    $("hudPill").textContent = `${(p.baseT-p.remT)}/${p.baseT} · ${chrono}`;
  }
}
function renderAll(){
  applyTheme();
  maybeNewTagline();
  renderProgress();
  renderPomodoro();
  renderCurrentTask();
  renderBelowList();
  renderFocus();
  renderNotes();
}

/* ============================================================
  Wire UI
============================================================ */
function bindUI(){
  // topbar
  if($("btnLeft"))  $("btnLeft").onclick  = ()=>panelOpen("left", true);
  if($("btnRight")) $("btnRight").onclick = ()=>{ panelOpen("right", true); renderRightPanel(); };
  if($("leftBack")) $("leftBack").onclick = ()=>panelOpen("left", false);
  if($("rightBack"))$("rightBack").onclick= ()=>panelOpen("right", false);
  if($("leftClose"))$("leftClose").onclick= ()=>panelOpen("left", false);
  if($("rightClose"))$("rightClose").onclick= ()=>panelOpen("right", false);

  if($("btnTheme")) $("btnTheme").onclick = ()=>{
    state.ui.theme = (state.ui.theme==="pastel-dark") ? "pastel-light" : "pastel-dark";
    saveState(); renderAll(); renderRightPanel();
  };
  if($("btnSeason")) $("btnSeason").onclick = ()=>{
    const i = SEASONS.indexOf(state.ui.season);
    state.ui.season = SEASONS[(i+1)%SEASONS.length];
    saveState(); renderAll(); renderRightPanel();
  };

  if($("btnFocus")) $("btnFocus").onclick = ()=>enterFocus();
  if($("btnExitFocus")) $("btnExitFocus").onclick = ()=>exitFocus();

  // main actions
  if($("btnEto")) $("btnEto").onclick = degommeEtorion;
  if($("btnUndo")) $("btnUndo").onclick = undo;

  if($("btnRoulette")) $("btnRoulette").onclick = ()=>{
    const list = sortTasks(activeTasks());
    if(!list.length) return;
    const pinned = list.filter(t=>t.pinned);
    const pool = pinned.length ? pinned : list;
    const pick = pool[Math.floor(Math.random()*pool.length)];
    state.currentTaskId = pick.id;
    saveState();
    renderAll();
  };

  if($("btnList")) $("btnList").onclick = ()=>{
    state.ui.showBelowList = !state.ui.showBelowList;
    saveState();
    renderAll();
  };
  if($("btnHideList")) $("btnHideList").onclick = ()=>{
    state.ui.showBelowList = false;
    saveState();
    renderAll();
  };

  if($("btnEdit")) $("btnEdit").onclick = ()=>{
    const t = getTask(state.currentTaskId);
    if(!t) return;
    openTaskEditor(t.id);
  };

  if($("btnPause")) $("btnPause").onclick = ()=>{
    toggleGlobalPause();
    renderAll();
  };

  if($("btnKiff")) $("btnKiff").onclick = showKiffance;

  // notes modal
  if($("btnNotes")) $("btnNotes").onclick = ()=>openModal("notesModal");
  if($("noteAdd")) $("noteAdd").onclick = ()=>{
    addNote($("noteInput")?.value||"");
    if($("noteInput")) $("noteInput").value="";
  };
  if($("noteClear")) $("noteClear").onclick = ()=>{
    if(!confirm("Vider les notes ?")) return;
    state.notes = [];
    saveState();
    renderNotes();
  };

  // pomodoro
  if($("btnPomoToggle")) $("btnPomoToggle").onclick = ()=>{
    state.pomodoro.visible = !state.pomodoro.visible;
    saveState(); renderPomodoro();
  };
  if($("btnPomoStart")) $("btnPomoStart").onclick = ()=>{
    if(!state.pomodoro.running) pomodoroStart();
    else pomodoroPauseToggle();
    renderPomodoro();
  };
  if($("btnPomoStop")) $("btnPomoStop").onclick = ()=>{
    pomodoroStop();
    renderPomodoro();
  };

  // click time => set minutes
  if($("pomoClickZone")) $("pomoClickZone").onclick = ()=>{
    const v = prompt("Durée pomodoro (minutes, 5 à 90) :", String(state.pomodoro.minutes||25));
    if(v===null) return;
    state.pomodoro.minutes = clamp(parseInt(v,10)||25, 5, 90);
    if(!state.pomodoro.running) renderPomodoro();
    saveState();
  };

  // focus overlay buttons mirror
  if($("fEto")) $("fEto").onclick = degommeEtorion;
  if($("fUndo")) $("fUndo").onclick = undo;
  if($("fNotes")) $("fNotes").onclick = ()=>openModal("notesModal");
  if($("fPause")) $("fPause").onclick = ()=>{ toggleGlobalPause(); renderAll(); };
  if($("fKiff")) $("fKiff").onclick = showKiffance;
  if($("fPomoStart")) $("fPomoStart").onclick = ()=>{
    if(!state.pomodoro.running) pomodoroStart();
    else pomodoroPauseToggle();
    renderAll();
  };
  if($("fPomoStop")) $("fPomoStop").onclick = ()=>{ pomodoroStop(); renderAll(); };
  if($("fPomoClick")) $("fPomoClick").onclick = ()=>$("pomoClickZone")?.click();

  // export
  if($("expRefresh")) $("expRefresh").onclick = ()=>{ if($("expOut")) $("expOut").value = exportText(); };
  if($("expCopy")) $("expCopy").onclick = async ()=>{
    const txt = exportText();
    if($("expOut")) $("expOut").value = txt;
    try{ await navigator.clipboard.writeText(txt); $("expCopy").textContent="copié"; }
    catch(_){ $("expCopy").textContent="échec"; }
    setTimeout(()=>{ $("expCopy").textContent="copier"; }, 900);
  };

  // keyboard
  document.addEventListener("keydown",(e)=>{
    if(e.key==="Escape"){
      closeAllModals();
      if(state.ui.focus) exitFocus();
      panelOpen("left", false);
      panelOpen("right", false);
    }
    // espace => pause global (si pas dans input)
    const tag = (document.activeElement?.tagName||"").toLowerCase();
    if(e.code==="Space" && !["input","textarea","select"].includes(tag)){
      e.preventDefault();
      toggleGlobalPause();
      renderAll();
    }
  });
}

/* ============================================================
  TICK LOOP
============================================================ */
let tick = null;
function startTick(){
  if(tick) return;
  tick = setInterval(()=>{
    // pomodoro countdown
    if(state.pomodoro.running && !state.pomodoro.paused){
      const left = pomodoroLeftMs();
      if(left!==null && left<=0){
        pomodoroStop();
        renderPomodoro();
        showKiffance();
      }else{
        renderPomodoro();
      }
    }
    // HUD pill time
    if($("hudPill")) {
      const p = computeProgress();
      $("hudPill").textContent = `${(p.baseT-p.remT)}/${p.baseT} · ${formatMMSS(timerNowMs())}`;
    }
  }, 500);
}

/* ============================================================
  Boot
============================================================ */
(function boot(){
  // init basics
  if(!state.timer.startedAt) state.timer.startedAt = Date.now();

  seedKiffanceIfEmpty();
  seedSetsHabitsIfEmpty();
  ensureBaseline(false);
  ensureCurrentTask();

  applyTheme();
  initPanelResizer("left");
  initPanelResizer("right");
  bindModalClose();
  initFX();
  bindUI();
  startTick();

  // initial render
  renderAll();
})();
</script>
</body>
</html>
